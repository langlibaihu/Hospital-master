/*! 2016 Baidu Inc. All Rights Reserved */
define("common/js/suggest",["require"],function(require){function e(e){if(e&&e.replace(/(^\s*)|(\s*$)/g,""))return!1;else return!0}function t(e){if(!e)return"";else return e.replace("&","&amp;").replace("<","&lt;").replace(">","&gt;").replace('"',"&quot;").replace("'","&#39;")}var exports={initFalg:!1,initSug:function(){function i(t,i,r,o,a,s){if(!(i&&r&&o&&a))return{};var l=this;l.defaultKey=a.defaultKey||"",l.cacheKey=a.sugKey||"",l._ajaxUrl=i,l.$container=$(o),l.$input=t,l.$searchBtn=$(a.searchBtn||""),l.styles=s||{},l._curIndex=0,l._fnCallback=r||function(){return!1},l.defaultData=a.defaultData||"",l._ajaxCount=1,l.isMoved=!1,l.lastQuery="",l.ie8InputChangeFlag=!1,l.initialize=function(){var t=this;if(t.initStyle(),t.$container.delegate(".clean-search-suggeat","mousedown",function(){t.cleanLocalStorageOfKey(t.cacheKey),t.$container.html("").hide()}),t.$container.delegate(".jq-sug-item","mouseenter",function(){if(t.isMoved)t.$container.find("li").css("background-color","#fff"),t.isMoved=!1;$(this).css("background-color",t.styles.liHoverColor)}),t.$container.delegate(".jq-sug-item","mouseleave",function(){$(this).css("background-color","#fff")}),t.$container.delegate(".jq-sug-item","mousedown",function(){t.$input.val($(this).data("value")),t.submitFun(t.$container.find("li").index($(this)))}),t.$searchBtn.off("click").on("click",function(){t.submitFun()}),9==n||8==n){if(""==t.$input.val())t.$input.val(t.defaultKey).css("color","#c8c8c8");t.$input.on("blur",function(){var n=t.$input.val();if(e(n)||n==t.defaultKey)t.$container.html("").hide(),t.ie8InputChangeFlag=!0,t.$input.val(t.defaultKey).css("color","#c8c8c8");else t.$container.hide()}),t.$input.on("focus",function(){if($(this).val()==t.defaultKey)t.ie8InputChangeFlag=!0,t.$input.val("").css("color","#333333");if(!e($(this).val())){if(""!=t.$container.html())t.$container.show()}else if(t.cacheKey)t.viewLocalStorage()}),t.$input[0].attachEvent("onpropertychange",function(n){var i=t.$input.val();if(t.ie8InputChangeFlag)return t.ie8InputChangeFlag=!1,!1;if("value"!=n.propertyName.toLowerCase())return!1;if(!t.$input.is(":focus"))return!1;if(t._curIndex=0,e(t.$input.val())||t.$input.val()==t.defaultKey)t.viewLocalStorage();else t.request(i)})}else t.$input.on("blur",function(){var n=t.$input.val();if(e(n))t.$input.val(""),t.$container.html("").hide();else t.$container.hide()}),t.$input.on("focus",function(){if(!e($(this).val())){if(""!=t.$container.html())t.$container.show()}else if(t.cacheKey)t.viewLocalStorage()}),t.$input.on("input",function(){if(!t.$input.is(":focus"))return!1;t._curIndex=0;var n=t.$input.val();if(e(n))return void t.viewLocalStorage();else t.request(n)});t.$input.on("keydown",function(e){if(38==e.which)return!1;else return void 0}),t.$input.on("keyup",function(e){var i=e.which;if(13===i)return t.submitFun(),!1;if(!(8!=n&&9!=n||8!=i&&46!=i))t.$input.val(t.$input.val());if("none"==t.$container.css("display"))return!0;if(40==i)return t.ie8InputChangeFlag=!0,t.pressDown(),!0;if(38==i)return t.ie8InputChangeFlag=!0,t.pressUp(),!0;else return void 0})},l.initialize()}if(!this.initFalg)this.initFalg=!0,i.prototype={submitFun:function(t){var n=this,i=n.$input.val();if(e(i)||i==n.defaultKey)return!1;if(oSugItem={},oSugItem.displayedQuery=i,oSugItem.type="",t){var r=n.$container.find("li").eq(t);oSugItem.type=r.find("span").text()||""}else n.$container.find("li:not(:first)").each(function(e,t){var n=$(t);if(i==n.data("value"))oSugItem.type=n.find("span").text()||""});n.writeLocalStorage(oSugItem,n.cacheKey),n._fnCallback(n.defaultData)},selectSug:function(e){var t=this,n=t.$container.find("li"),i=n.eq(e),r=t.$input;r.val(i.data("value")),n.css("background-color","#fff"),i.css("background-color",t.styles.liHoverColor),t.isMoved=!0},pressUp:function(){var e=this,t=e.$container.find("li").length;if(0==e._curIndex--)e.$container.find("li:eq(0)").data("value",e.$input.val());if(e._curIndex<0)e._curIndex=t-1;e.selectSug(e._curIndex)},pressDown:function(){var e=this,t=e.$container.find("li").length;if(0==e._curIndex++)e.$container.find("li:eq(0)").data("value",e.$input.val());if(e._curIndex>=t)e._curIndex=0;e.selectSug(e._curIndex)},initStyle:function(){var e=this;e.styles.ulStyles?"":e.styles.ulStyles="",e.styles.liStyles?"":e.styles.liStyles="height:32px;line-height:32px;",e.styles.liPStyles?"":e.styles.liPStyles="color:#666;text-indent:9px;cursor:default;overflow:hidden;max-width:300px;display:inline-block;white-space:nowrap;text-overflow:ellipsis;",e.styles.liSpanStyles?"":e.styles.liSpanStyles="color:#999;float:right;margin-right:11px;",e.styles.pStyles?"":e.styles.pStyles="height:32px;line-height:32px;text-indent:9px;text-align:right;",e.styles.pSpanStyles?"":e.styles.pSpanStyles="color:#999;cursor:pointer;margin-right:11px;",e.styles.emStyles?"":e.styles.emStyles="font-style:normal;color:#ff9026;",e.styles.liHoverColor?"":e.styles.liHoverColor="#f5fafe"},request:function(t){var n=this;if(t!=n.lastQuery)n.lastQuery=t,++n._ajaxCount>1e3?n._ajaxCount=1:"",$.ajax({url:n._ajaxUrl,data:{query:t,count:n._ajaxCount},async:!0,type:"get",dataType:"json",success:function(i){if(i&&0==i.status)if(i=i.data||"",n._ajaxCount==i.count&&!e(n.$input.val())&&n.$input.val()!=n.defaultKey)if(i.searchList.length>0)if(n.$input.is(":focus"))n.$container.html(n.render(i.searchList,t)).show();else n.$container.html(n.render(i.searchList,t)).hide();else n.$container.html("").hide();else return},error:function(){n.$container.html("").hide()},complete:function(){}})},readLocalStorage:function(){var e=this;if(!e.cacheKey)return[];var n=localStorage.getItem(e.cacheKey);if(!n)return[];var i=[];return n.split("bDyS").forEach(function(e,n){var r=e.split("BdYs");i.push({}),i[n].displayedQuery=t(window.decodeURIComponent(r[0])),i[n].passBackQuery=t(window.decodeURIComponent(r[1])),i[n].type="BDYS!!!"==window.decodeURIComponent(r[2])?"":t(window.decodeURIComponent(r[2]))}),i},writeLocalStorage:function(e){var t=this;if(!t.cacheKey||!e)return!1;var n=9,i=this.readLocalStorage(t.cacheKey);return sugStr=window.encodeURIComponent(e.displayedQuery)+"BdYs"+window.encodeURIComponent(e.displayedQuery)+"BdYs"+window.encodeURIComponent(e.type),i.forEach(function(t,i){if(t.displayedQuery!=e.displayedQuery&&n>i)sugStr+="bDyS"+window.encodeURIComponent(t.displayedQuery)+"BdYs"+window.encodeURIComponent(t.displayedQuery)+"BdYs"+window.encodeURIComponent(t.type?t.type:"BDYS!!!");else if(t.displayedQuery==e.displayedQuery)n=10}),window.localStorage.setItem(t.cacheKey,sugStr),!0},cleanLocalStorageOfKey:function(){var e=this;if(!e.cacheKey)return!1;else return localStorage.removeItem(e.cacheKey),!0},render:function(e,t,n){if(!e||e.length<=0)return"";var i=this,r=t||"",o=[];if(o.push('<ul style="'+i.styles.ulStyles+'">'),o.push('<li class="jq-sug-item" style="display:none;'+i.styles.liStyles+'" data-value="'+r+'">'+r+"</li>"),e.forEach(function(e,t){var r="";if(""!=e.type&&!n)r='<span style="'+i.styles.liSpanStyles+'">'+e.type+"</span>";o.push('<li class="jq-sug-item" style="'+i.styles.liStyles+'" data-value="'+e.passBackQuery+'"><p style="'+i.styles.liPStyles+'">'+e.displayedQuery.replace("<em>",'<em style="'+i.styles.emStyles+'">')+"</p>"+r+"</li>")}),o.push("</ul>"),n)o.push('<p style="'+i.styles.pStyles+'"><span class="clean-search-suggeat" style="'+i.styles.pSpanStyles+'">清空历史记录</span></p>');return o.join("")},viewLocalStorage:function(){var e=this;if(!e.cacheKey)return!1;var t=e.readLocalStorage(e.cacheKey);if(t.length<=0)return void e.$container.html("").hide();else return void e.$container.html(e.render(t,"",!0)).show()}},$.fn.extend({initSug:function(e,t,n,r,o){new i(this,e,t,n,r,o)}})}},n=function(){var e=-1;if("Microsoft Internet Explorer"==navigator.appName){var t=navigator.userAgent,n=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");if(null!=n.exec(t))e=parseFloat(RegExp.$1)}return e}();return{initialize:function(){exports.initSug()}}});